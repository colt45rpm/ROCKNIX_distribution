#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2024-present JELOS (https://github.com/JustEnoughLinuxOS)

. /etc/profile

EXTLCONF=/flash/extlinux/extlinux.conf
EXTLCONFBAK=${EXTLCONF}.orig

mount -o remount,rw /flash
case $1 in
  R36S)
    [ -f ${EXTLCONFBAK} ] || cp ${EXTLCONF} ${EXTLCONFBAK}
    grep -q '^ *FDT ' ${EXTLCONF} || sed -i 's|^\(.* FDTDIR .*$\)|\1\n  FDT todo.dtb|' ${EXTLCONF}
    sed -i 's|^ *FDT .*$|  FDT /rk3326-gameconsole-r36s.dtb|' ${EXTLCONF}
    rm -r /storage/remappings/*
  ;;
  *)
    [ -f ${EXTLCONFBAK} ] && cp ${EXTLCONFBAK} ${EXTLCONF}
    rm -r /storage/remappings/*
  ;;
esac

cat <<EOF >/flash/device.name
$1
EOF

sync
[ -z "${DEBUGGING}" ] && reboot
