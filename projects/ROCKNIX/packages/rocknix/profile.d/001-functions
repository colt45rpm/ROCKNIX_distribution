# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2019-present Shanti Gilbert (https://github.com/shantigilbert)
# Copyright (C) 2023 JELOS (https://github.com/JustEnoughLinuxOS)

. /etc/os-release

export XDG_RUNTIME_DIR=/var/run/0-runtime-dir
export PATH="/usr/bin:/usr/local/bin:/storage/bin:${PATH}"
export SDL_GAMECONTROLLERCONFIG_FILE="/storage/.config/SDL-GameControllerDB/gamecontrollerdb.txt"

function tocon() {
  echo -ne "\033[1000H\033[2K==> ${*}" >/dev/console
}

function log() {
  SOURCE=${1//\/*\//}
  MESSAGE=${*#${1}}
  MESSAGE=${MESSAGE# }
  logger -t ${SOURCE} "${MESSAGE}"
  echo "$(date) ${SOURCE}: ${MESSAGE}" >>/var/log/messages
}

function fbwidth() {
  local ORIENTATION=$(</sys/devices/virtual/graphics/fbcon/rotate)
  if [ "${ORIENTATION}" = "0" ]
  then
    fbset | awk '/geometry/ {print $2}'
  else
    fbset | awk '/geometry/ {print $3}'
  fi
}

function fbheight() {
  local ORIENTATION=$(</sys/devices/virtual/graphics/fbcon/rotate)
  if [ "${ORIENTATION}" = "0" ]
  then
    fbset | awk '/geometry/ {print $3}'
  else
    fbset | awk '/geometry/ {print $2}'
  fi
}

# sway window manager utility function to enable fullscreen on a window for an input app_id
function sway_fullscreen {
  # value for swaymsg criteria
  # for 'virtual' attributes pidof / pgrep this is the process to look up pid for
  local VALUE="${1}"
  
  # attribute for swaymsg criteria - default to app_id for backwards compatibility
  # 'virtual' attributes pidof / pgrep result in the value being evaluted at runtime
  local ATTRIBUTE="${2:-app_id}"

  # retry control vars
  local QUERY_LIMIT=5
  local QUERY_COUNT=0

  if echo "${UI_SERVICE}" | grep "sway"; then
    while [ $QUERY_COUNT -lt $QUERY_LIMIT ]; do
      # loop, attempting to fullscreen window for app_id
      ((QUERY_COUNT++))

      # Derive swaymsg criteria attribute and value where they are dynamic
      if [[ "${ATTRIBUTE}" = @(pidof|pgrep) ]]; then
        local PID=""

        case "${ATTRIBUTE}" in
          "pidof")
            PID=$(pidof "${VALUE}")
            ;;
          "pgrep")
            PID=$(pgrep "${VALUE}")
            ;;
        esac

        if [ -z "${PID}" ]; then
          echo "No PID found for VALUE=${VALUE}"
          sleep 1
          continue
        else
          ATTRIBUTE="pid"
          VALUE="${PID}"
        fi
      fi

      echo "Attempting to fullscreen ${ATTRIBUTE}=${VALUE}"
      swaymsg '['"${ATTRIBUTE}"'='"${VALUE}"'] fullscreen enable'
      local RESULT=$?

      if [ $RESULT -eq 0 ]; then
        echo "Successful, exiting"
        break
      else
        echo "Failed, waiting to try again"
        sleep 1
      fi
    done
  else
    echo "sway is not running, exiting"
  fi
}
